#!/usr/bin/env ruby

$dir = File.dirname ARGV.first || '.'
$r_include = %r{/\*>\s*(.+?)\s*\*/}
$r_include_inside_string = Regexp.new('"' << $r_include.source << '"')


def get_file(path='')
  if path.index('http://') or path.index('https://')
    require 'open-uri'
    open(path).read
  else
    File.read File.join($dir, path)
  end
end

def parse(text='')
  text.gsub!($r_include_inside_string) {
    '"' << parse(get_file $1).gsub(/$/, '\\').chop << '"'
  }
  text.gsub!($r_include) {
    parse(get_file $1)
  }
  text
end

if ($stdin.tty? && ARGV.empty?) || ARGV.delete('-h') || ARGV.delete('--help')
  puts <<-multiline

          JavaScript Preprocessor

  Usage:  jspp input > output

Example:      main.js:  /*> script.js */

                        var style = "/*> style.css */";

            style.css:  html, body {margin:0; padding:0}
                        /*> http://nv.github.com/js-preprocessor/example/style-child.css */
                        .my-style {background: #fffacc}

      style-child.css:  .i-am-child {}

            script.js:  var my_script;

 jspp example/main.js:  var my_script;

                        var style = "html, body {margin:0; padding:0}\\ 
                        .i-am-child {}\\
                        .my-style {background: #fffacc}"
  multiline
else
  print parse ARGF.read
end
